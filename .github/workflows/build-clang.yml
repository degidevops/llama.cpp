name: llama.cpp - ULTIMATE FULL FEATURES + MAX OPTIMIZED (Nov 2025)

on:
  workflow_dispatch:
  push:
    branches: [ master, main ]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: win-avx512-ultimate
            os: windows-latest
            cmake_flags: "-DGGML_AVX512=ON -DGGML_AVX512_VBMI=ON -DGGML_AVX512_VNNI=ON -DGGML_AVX512_BF16=ON -DGGML_AVX2=ON -DGGML_AVX=ON -DGGML_F16C=ON -DGGML_FMA=ON -DGGML_LTO=ON"
            artifact: llama-win-avx512-ultimate.exe
          - name: win-cuda-ultimate
            os: windows-latest
            cmake_flags: "-DGGML_CUDA=ON -DGGML_CUDA_F16=ON -DGGML_LTO=ON -DCMAKE_CUDA_ARCHITECTURES=all-major"
            artifact: llama-win-cuda-ultimate.exe
            cuda: true
          - name: linux-avx512-ultimate
            os: ubuntu-latest
            cmake_flags: "-DGGML_AVX512=ON -DGGML_AVX512_VBMI=ON -DGGML_AVX512_VNNI=ON -DGGML_AVX2=ON -DGGML_AVX=ON -DGGML_F16C=ON -DGGML_FMA=ON -DGGML_NATIVE=ON -DGGML_LTO=ON"
            artifact: llama-linux-avx512-ultimate
          - name: linux-cuda-ultimate
            os: ubuntu-latest
            cmake_flags: "-DGGML_CUDA=ON -DGGML_CUDA_F16=ON -DGGML_LTO=ON -DCMAKE_CUDA_ARCHITECTURES=all-major"
            artifact: llama-linux-cuda-ultimate
            cuda: true
          - name: linux-vulkan-ultimate
            os: ubuntu-latest
            cmake_flags: "-DGGML_VULKAN=ON -DGGML_NATIVE=ON -DGGML_LTO=ON"
            artifact: llama-linux-vulkan-ultimate

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt update -qq
          sudo apt install -y build-essential cmake ninja-build libcurl4-openssl-dev libvulkan-dev glslc libshaderc-dev

      - name: Install CUDA 12.6.2
        if: matrix.cuda
        uses: Jimver/cuda-toolkit@v0.2.29
        with:
          cuda: "12.6.2"
          method: network

      - name: Setup MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install libcurl via vcpkg (Windows only)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          git clone --depth 1 https://github.com/microsoft/vcpkg.git
          ./vcpkg/bootstrap-vcpkg.bat
          ./vcpkg/vcpkg install curl:x64-windows-static-md --triplet x64-windows-static-md
          echo "VCPKG_ROOT=$(pwd)/vcpkg" >> $GITHUB_ENV

      - name: CMake Configure - FULL FEATURES + MAX OPTIMIZED
        shell: bash
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DLLAMA_BUILD_SERVER=ON \
            -DLLAMA_BUILD_EXAMPLES=ON \
            -DLLAMA_CURL=ON \
            -DLLAMA_TOOL_USE=ON \        # ← Tool / Function Calling FULL
            -DLLAMA_MULTIMODAL=ON \      # ← Vision / Llava / Llama-3.2-Vision
            -DLLAMA_EMBEDDING=ON \       # ← llama-embedding binary
            -DLLAMA_LTO=ON \             # ← Link Time Optimization (speed++)
            ${{ runner.os == 'Windows' && '-DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=x64-windows-static-md' || '' }} \
            ${{ matrix.cmake_flags }}

      - name: Build
        run: cmake --build build --config Release --parallel

      # ==================== UPX ULTIMATE (ultra-brute = terkecil sedunia) ====================
      - name: Get latest UPX version
        id: upx
        shell: pwsh
        run: |
          $json = Invoke-WebRequest -Uri https://api.github.com/repos/upx/upx/releases/latest -UseBasicParsing | ConvertFrom-Json
          $ver = $json.tag_name -replace '^v', ''
          "version=$ver" >> $env:GITHUB_OUTPUT

      - name: Download & extract UPX (Linux)
        if: runner.os == 'Linux'
        run: |
          VER=${{ steps.upx.outputs.version }}
          curl -L -o upx.tar.xz https://github.com/upx/upx/releases/download/v$VER/upx-${VER}-amd64_linux.tar.xz
          tar -xJf upx.tar.xz --strip-components=1
          chmod +x upx

      - name: Download & extract UPX (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ver = "${{ steps.upx.outputs.version }}"
          Invoke-WebRequest -Uri "https://github.com/upx/upx/releases/download/v$ver/upx-$ver-win64.zip" -OutFile upx.zip
          Expand-Archive -Path upx.zip -DestinationPath . -Force
          Move-Item "upx-*-win64/upx.exe" upx.exe -Force

      - name: Compress with UPX --ultra-brute (paling kecil!)
        continue-on-error: true
        shell: bash
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
            ./upx.exe --ultra-brute "build/bin/llama-server.exe" "build/bin/llama-cli.exe" "build/bin/llama-embedding.exe" 2>nul || true
          else
            ./upx --ultra-brute build/bin/Release/llama-server build/bin/Release/llama-cli build/bin/Release/llama-embedding 2>/dev/null || true
          fi

      # ==================== PREPARE ARTIFACTS (PATH BENAR 2025) ====================
      - name: Prepare artifacts
        shell: bash
        run: |
          mkdir -p release
          if [ "${{ runner.os }}" = "Windows" ]; then
            # Windows → build/bin/
            cp build/bin/llama-server.exe release/${{ matrix.artifact }}
            [ -f build/bin/llama-cli.exe ] && cp build/bin/llama-cli.exe release/llama-cli-${{ matrix.artifact }} || true
            [ -f build/bin/llama-embedding.exe ] && cp build/bin/llama-embedding.exe release/llama-embedding-${{ matrix.artifact }} || true
          else
            # Linux → build/bin/Release/
            cp build/bin/Release/llama-server release/${{ matrix.artifact }}
            [ -f build/bin/Release/llama-cli ] && cp build/bin/Release/llama-cli release/llama-cli-${{ matrix.artifact }} || true
            [ -f build/bin/Release/llama-embedding ] && cp build/bin/Release/llama-embedding release/llama-embedding-${{ matrix.artifact }} || true
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: release/*
