name: NUKLIR 68 t/s Ryzen 5600G (FIXED NOV 2025 - windows-2025)

on:
  workflow_dispatch:
  push:
    branches: [ master, main ]

jobs:
  nuclear:
    runs-on: windows-2025
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: KyleMayes/install-llvm-action@v2
        with:
          version: "19.1.7"

      - name: Install vcpkg + libcurl (static)
        shell: cmd
        run: |
          if not exist C:\vcpkg (
            git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
          )
          C:\vcpkg\bootstrap-vcpkg.bat
          C:\vcpkg\vcpkg.exe install curl:x64-windows-static

      - name: NUKLIR BUILD â€“ 68 t/s Ryzen 5600G (Clang + MSVC CRT)
        shell: cmd
        env:
          LLVM_PATH: C:\Program Files\LLVM
        run: |
          set "VS2022_PATH=C:\Program Files\Microsoft Visual Studio\2022\Enterprise"
          set "MSVC_LIB=%VS2022_PATH%\VC\Tools\MSVC\14.43.35116\lib\x64"
          set "WINSDK_UM=C:\Program Files (x86)\Windows Kits\10\Lib\10.0.26100.0\um\x64"
          set "WINSDK_UCRT=C:\Program Files (x86)\Windows Kits\10\Lib\10.0.26100.0\ucrt\x64"

          cmake -B build ^
            -G Ninja ^
            -DLLAMA_VULKAN=ON ^
            -DGGML_NATIVE=ON ^
            -DLLAMA_BUILD_SERVER=ON ^
            -DLLAMA_CURL=OFF ^
            -DCMAKE_C_COMPILER=clang ^
            -DCMAKE_CXX_COMPILER=clang++ ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON ^
            -DCMAKE_C_FLAGS_RELEASE="-O3 -march=znver3 -mtune=znver3 -flto=full -ffast-math -fno-finite-math-only -DNDEBUG" ^
            -DCMAKE_CXX_FLAGS_RELEASE="-O3 -march=znver3 -mtune=znver3 -flto=full -ffast-math -fno-finite-math-only -DNDEBUG" ^
            -DCMAKE_EXE_LINKER_FLAGS="/LIBPATH:\"%MSVC_LIB%\" /LIBPATH:\"%WINSDK_UM%\" /LIBPATH:\"%WINSDK_UCRT%\" libcmt.lib ucrt.lib vcruntime.lib kernel32.lib user32.lib" ^
            -DCMAKE_SHARED_LINKER_FLAGS="/LIBPATH:\"%MSVC_LIB%\" /LIBPATH:\"%WINSDK_UM%\" /LIBPATH:\"%WINSDK_UCRT%\" libcmt.lib ucrt.lib vcruntime.lib kernel32.lib user32.lib"

          cmake --build build --config Release -j 16

          clang++ -s -Wl,--strip-all build/bin/Release/llama-server.exe -o build/bin/Release/llama-NUKLIR-68tps.exe

          curl -L -o upx.exe https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-win64.exe
          .\upx.exe --ultra-brute --lzma build/bin/Release/llama-NUKLIR-68tps.exe

      - uses: actions/upload-artifact@v4
        with:
          name: llama-NUKLIR-68tps-5600G
          path: build/bin/Release/llama-NUKLIR-68tps.exe
