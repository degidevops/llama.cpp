name: NUKLIR 68 t/s Ryzen 5600G (FINAL – REGEX + PowerShell)

on:
  workflow_dispatch:
  push:
    branches: [ master, main ]

jobs:
  nuclear:
    runs-on: windows-2025
    timeout-minutes: 45
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install LLVM + Clang 19.1.7
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "19.1.7"

      - name: Install vcpkg + curl (static)
        shell: cmd
        run: |
          if not exist C:\vcpkg (
            git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
          )
          C:\vcpkg\bootstrap-vcpkg.bat
          C:\vcpkg\vcpkg.exe install curl:x64-windows-static

      - name: DETECT PATHS – REGEX + PowerShell (SUPER CEPET)
        id: paths
        shell: powershell
        run: |
          # === MSVC LIB (short path) ===
          $msvcPath = Get-Item "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC" | Select-Object -First 1
          if (-not $msvcPath) { throw "MSVC not found!" }

          $msvcLib = ($msvcPath.FullName + "\lib\x64")
          $msvcLib = $msvcLib -replace 'C:\\Program Files', 'C:\PROGRA~1'
          $msvcLib = $msvcLib -replace 'Microsoft Visual Studio', 'MICROS~2'
          $msvcLib = $msvcLib -replace '\\', '\'

          # === SDK UM & UCRT (latest 10.0.xxxx.0 via regex) ===
          $sdkRoot = "C:\Program Files (x86)\Windows Kits\10\Lib"
          if (-not (Test-Path $sdkRoot)) { throw "Windows SDK not found!" }

          $sdkRootShort = $sdkRoot -replace 'C:\\Program Files \(x86\)', 'C:\PROGRA~2'
          $sdkRootShort = $sdkRootShort -replace 'Windows Kits', 'WI3CF2~1'

          $dirs = Get-ChildItem $sdkRoot | Where-Object {
            $_.PSIsContainer -and $_.Name -match '^10\.0\.\d+\.0$'
          } | Sort-Object Name -Descending

          if ($dirs.Count -eq 0) { throw "No valid SDK version found!" }
          $ver = $dirs[0].Name

          $um   = "$sdkRootShort\$ver\um\x64"
          $ucrt = "$sdkRootShort\$ver\ucrt\x64"

          # Output
          Write-Host "MSVC_LIB: $msvcLib"
          Write-Host "WINSDK_UM: $um"
          Write-Host "WINSDK_UCRT: $ucrt"
          Write-Host "SDK_VER: $ver"

          "MSVC_LIB=$msvcLib" >> $env:GITHUBaitHUB_OUTPUT
          "WINSDK_UM=$um" >> $env:GITHUB_OUTPUT
          "WINSDK_UCRT=$ucrt" >> $env:GITHUB_OUTPUT
          "SDK_VER=$ver" >> $env:GITHUB_OUTPUT

      - name: NUKLIR BUILD – Clang + LTO + Vulkan + DOUBLE %%
        shell: cmd
        env:
          MSVC_LIB: ${{ steps.paths.outputs.MSVC_LIB }}
          WINSDK_UM: ${{ steps.paths.outputs.WINSDK_UM }}
          WINSDK_UCRT: ${{ steps.paths.outputs.WINSDK_UCRT }}
        run: |
          echo MSVC_LIB=%MSVC_LIB%
          echo WINSDK_UM=%WINSDK_UM%
          echo WINSDK_UCRT=%WINSDK_UCRT%

          cmake -B build ^
            -G Ninja ^
            -DLLAMA_VULKAN=ON ^
            -DGGML_NATIVE=ON ^
            -DLLAMA_BUILD_SERVER=ON ^
            -DLLAMA_CURL=OFF ^
            -DCMAKE_C_COMPILER=clang ^
            -DCMAKE_CXX_COMPILER=clang++ ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON ^
            -DCMAKE_C_FLAGS_RELEASE="-O3 -march=znver3 -mtune=znver3 -flto=full -ffast-math -fno-finite-math-only -DNDEBUG" ^
            -DCMAKE_CXX_FLAGS_RELEASE="-O3 -march=znver3 -mtune=znver3 -flto=full -ffast-math -fno-finite-math-only -DNDEBUG" ^
            -DCMAKE_EXE_LINKER_FLAGS=/LIBPATH:%%MSVC_LIB%% /LIBPATH:%%WINSDK_UM%% /LIBPATH:%%WINSDK_UCRT%% libcmt.lib ucrt.lib vcruntime.lib kernel32.lib ^
            -DCMAKE_SHARED_LINKER_FLAGS=/LIBPATH:%%MSVC_LIB%% /LIBPATH:%%WINSDK_UM%% /LIBPATH:%%WINSDK_UCRT%% libcmt.lib ucrt.lib vcruntime.lib kernel32.lib

          cmake --build build --config Release -j 16

          clang++ -s -Wl,--strip-all build/bin/Release/llama-server.exe -o build/bin/Release/llama-NUKLIR-68tps.exe

          curl -L -o upx.exe https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-win64.exe
          .\upx.exe --ultra-brute --lzma build/bin/Release/llama-NUKLIR-68tps.exe

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: llama-NUKLIR-68tps-5600G
          path: build/bin/Release/llama-NUKLIR-68tps.exe
