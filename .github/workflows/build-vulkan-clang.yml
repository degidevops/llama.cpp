name: NUKLIR 100 t/s Ryzen 5600G (FINAL FIX - ABSOLUTE PATH)

on:
  workflow_dispatch:
  push:
    branches: [ master, main ]

jobs:
  nuclear:
    runs-on: windows-2025
    timeout-minutes: 30
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSVC Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: amd64

      - name: NUKLIR BUILD â€“ MSVC + LLD (MAX SPEED)
        shell: cmd
        run: |
          cmake -B build ^
            -G Ninja ^
            -DGGML_NATIVE=ON ^
            -DLLAMA_BUILD_SERVER=ON ^
            -DLLAMA_CURL=OFF ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_C_FLAGS_RELEASE="/O2 /arch:AVX2 /GL /DNDEBUG" ^
            -DCMAKE_CXX_FLAGS_RELEASE="/O2 /arch:AVX2 /GL /DNDEBUG" ^
            -DCMAKE_EXE_LINKER_FLAGS="/LTCG:incremental /OPT:REF /OPT:ICF"

          cmake --build build --config Release -j 16

          REM --- MASUK KE FOLDER BUILD ---
          pushd build\bin\Release

          REM --- CEK FILE DENGAN DIR (PASTIKAN ADA) ---
          dir llama-server.exe
          if errorlevel 1 (
            echo "ERROR: llama-server.exe TIDAK DITEMUKAN DI $(pwd)!"
            popd
            exit /b 1
          )

          REM --- COPY DENGAN NAMA BARU ---
          copy /Y llama-server.exe llama-NUKLIR-100tps.exe
          if errorlevel 1 (
            echo "COPY GAGAL!"
            popd
            exit /b 1
          )

          REM --- CEK HASIL ---
          dir llama-NUKLIR-100tps.exe

          REM --- KEMBALI KE ROOT ---
          popd

          REM --- DOWNLOAD UPX 64-BIT ---
          curl -L -o upx.zip https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-win64.zip
          tar -xf upx.zip
          move upx-4.2.4-win64\upx.exe .

          REM --- KOMPRES DARI PATH YANG BENAR ---
          .\upx.exe --best --lzma "build\bin\Release\llama-NUKLIR-100tps.exe"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: llama-NUKLIR-100tps-5600G
          path: build/bin/Release/llama-NUKLIR-100tps.exe
